<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Road Safety Risk Assessment</title>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* MODE TOGGLE STYLES */
        .mode-toggle-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            flex: 1;
            max-width: 250px;
            padding: 1rem 2rem;
            border: 3px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
            box-shadow: 0 5px 20px rgba(255,255,255,0.3);
        }

        .mode-btn i {
            margin-right: 0.5rem;
            font-size: 1.3rem;
        }

        .mode-description {
            text-align: center;
            color: white;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        /* AUTO MODE SPECIFIC STYLES */
        .auto-mode-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .auto-mode-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            transform: scale(1.02);
        }

        .upload-zone.dragover {
            border-color: #28a745;
            background: rgba(40,167,69,0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin-top: 1rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .license-status {
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-weight: 600;
        }

        .license-status.valid {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .license-status.invalid {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .license-status.processing {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .auto-filled-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .route-map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .weather-widget h5 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.2);
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step.completed .step-number::after {
            content: 'âœ“';
        }

        .step-label {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .processing-overlay.active {
            display: flex;
        }

        .processing-content {
            background: white;
            padding: 3rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }

        .processing-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-control:disabled, .form-select:disabled {
            background-color: #f0f8ff;
            border-color: #667eea;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-car-crash"></i> AI Road Safety Predictor</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/predict">Risk Assessment</a>
                <a class="nav-link" href="/about">About</a>
            </div>
        </div>
    </nav>

    <div class="risk-form-container">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <div class="form-card p-4">
                        <div class="text-center mb-4">
                            <h1 class="display-6"><i class="fas fa-shield-alt text-primary"></i> AI Road Safety Risk Assessment</h1>
                            <p class="lead text-muted">Advanced ML-powered analysis with 94.7% accuracy</p>
                        </div>

                        <!-- MODE TOGGLE -->
                        <div class="mode-toggle-container">
                            <div class="mode-toggle">
                                <button type="button" class="mode-btn active" data-mode="manual">
                                    <i class="fas fa-edit"></i> Manual Mode
                                </button>
                                <button type="button" class="mode-btn" data-mode="auto">
                                    <i class="fas fa-magic"></i> Auto Mode
                                </button>
                            </div>
                            <div class="mode-description">
                                <span id="manual-desc" class="active">Fill all fields manually with your trip details</span>
                                <span id="auto-desc" style="display:none;">Let AI automatically fill everything - just upload license & select route!</span>
                            </div>
                        </div>

                        <!-- AUTO MODE PANEL -->
                        <div class="auto-mode-panel" id="autoModePanel">
                            <!-- Step Indicator -->
                            <div class="step-indicator">
                                <div class="step active" data-step="1">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Upload License</div>
                                </div>
                                <div class="step" data-step="2">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Select Route</div>
                                </div>
                                <div class="step" data-step="3">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Review & Analyze</div>
                                </div>
                            </div>

                            <!-- STEP 1: License Upload -->
                            <div class="form-section" id="licenseUploadSection">
                                <div class="section-header">
                                    <h4><i class="fas fa-id-card"></i> Step 1: Upload Driver's License</h4>
                                </div>
                                
                                <div class="upload-zone" id="licenseUploadZone">
                                    <input type="file" id="licenseInput" accept="image/*" />
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <h5>Click or Drag to Upload License</h5>
                                    <p class="text-muted mb-0">Supports JPG, PNG (Max 5MB)</p>
                                    <button type="button" class="btn btn-outline-primary mt-3" onclick="document.getElementById('licenseInput').click()">
                                        <i class="fas fa-folder-open"></i> Browse Files
                                    </button>
                                </div>

                                <div id="licensePreview" style="display:none;">
                                    <img id="licenseImage" class="preview-image" alt="License Preview" />
                                    <div id="licenseStatus" class="license-status processing">
                                        <i class="fas fa-spinner fa-spin"></i> Processing license...
                                    </div>
                                    <div id="extractedInfo" style="display:none; margin-top:1rem;">
                                        <div class="alert alert-info">
                                            <h6><i class="fas fa-info-circle"></i> Extracted Information:</h6>
                                            <ul id="extractedDataList" class="mb-0"></ul>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="resetLicenseUpload()">
                                        <i class="fas fa-times"></i> Remove & Upload Different License
                                    </button>
                                </div>
                            </div>

                            <!-- STEP 2: Route Selection -->
                            <div class="form-section" id="routeSelectionSection" style="display:none;">
                                <div class="section-header">
                                    <h4><i class="fas fa-route"></i> Step 2: Select Your Route</h4>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Source Location</label>
                                        <input type="text" class="form-control" id="autoSourceLocation" placeholder="Enter starting point">
                                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="useCurrentLocationAsSource()">
                                            <i class="fas fa-location-arrow"></i> Use Current Location
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Destination Location</label>
                                        <input type="text" class="form-control" id="autoDestLocation" placeholder="Enter destination">
                                    </div>
                                </div>

                                <div class="route-map-container" id="routeMap">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <p class="text-muted"><i class="fas fa-map-marked-alt"></i> Map will load after route selection</p>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-primary mt-3" onclick="analyzeRoute()">
                                    <i class="fas fa-search"></i> Analyze Route & Get Conditions
                                </button>
                            </div>

                            <!-- STEP 3: Auto-filled Form Review -->
                            <div class="form-section" id="reviewSection" style="display:none;">
                                <div class="section-header">
                                    <h4><i class="fas fa-check-circle"></i> Step 3: Review Auto-Filled Data</h4>
                                </div>
                                
                                <!-- Weather Widget -->
                                <div class="weather-widget" id="weatherWidget" style="display:none;">
                                    <h5><i class="fas fa-cloud-sun"></i> Current Weather Conditions</h5>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div><strong>Weather:</strong> <span id="currentWeather">-</span></div>
                                        </div>
                                        <div class="col-md-3">
                                            <div><strong>Temperature:</strong> <span id="currentTemp">-</span></div>
                                        </div>
                                        <div class="col-md-3">
                                            <div><strong>Visibility:</strong> <span id="currentVisibility">-</span></div>
                                        </div>
                                        <div class="col-md-3">
                                            <div><strong>Road Surface:</strong> <span id="roadSurfaceCondition">-</span></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-success mt-3">
                                    <i class="fas fa-magic"></i> <strong>All fields auto-filled!</strong> Review below and edit if needed, then click analyze.
                                </div>
                            </div>
                        </div>

                        <!-- MAIN FORM (Used for both modes) -->
                        <form id="riskAssessmentForm">
                            <!-- Location Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h4>
                                        <i class="fas fa-map-marker-alt"></i> Location Information
                                        <span class="auto-filled-badge" id="locationBadge" style="display:none;">
                                            <i class="fas fa-bolt"></i> Auto-filled
                                        </span>
                                    </h4>
                                </div>
                                <div class="location-input-group">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label for="location" class="form-label">Current Location/Route</label>
                                            <input type="text" class="form-control" id="location" name="location" placeholder="Enter city, area or route name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="area_type" class="form-label">Area Type</label>
                                            <select class="form-select" id="area_type" name="area_type">
                                                <option value="Urban">Urban</option>
                                                <option value="Suburban">Suburban</option>
                                                <option value="Rural">Rural</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="button" id="use-location-btn" class="btn btn-outline-primary btn-sm mt-2">
                                        <i class="fas fa-map-marker-alt"></i> Use Current Location
                                    </button>
                                </div>
                            </div>

                            <!-- Vehicle & Driver Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h4>
                                        <i class="fas fa-car"></i> Vehicle & Driver Details
                                        <span class="auto-filled-badge" id="driverBadge" style="display:none;">
                                            <i class="fas fa-bolt"></i> Auto-filled
                                        </span>
                                    </h4>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="vehicle_type" class="form-label">Vehicle Type</label>
                                        <select class="form-select" id="vehicle_type" name="vehicle_type">
                                            <option value="Car">Car</option>
                                            <option value="Bike">Motorcycle/Bike</option>
                                            <option value="Truck">Truck</option>
                                            <option value="Bus">Bus</option>
                                            <option value="Auto-rickshaw">Auto-rickshaw</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="driver_age" class="form-label">Driver Age</label>
                                        <input type="number" class="form-control" id="driver_age" name="driver_age" min="16" max="80" value="30">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="experience" class="form-label">Driving Experience (years)</label>
                                        <input type="number" class="form-control" id="experience" name="experience" min="0" max="50" value="5">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="license_valid" class="form-label">Valid License</label>
                                        <select class="form-select" id="license_valid" name="license_valid">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="seatbelt" class="form-label">Seatbelt/Helmet</label>
                                        <select class="form-select" id="seatbelt" name="seatbelt">
                                            <option value="yes">Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Environmental Conditions -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h4>
                                        <i class="fas fa-cloud-sun"></i> Environmental Conditions
                                        <span class="auto-filled-badge" id="weatherBadge" style="display:none;">
                                            <i class="fas fa-bolt"></i> Auto-filled
                                        </span>
                                    </h4>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="weather" class="form-label">Weather</label>
                                        <select class="form-select" id="weather" name="weather">
                                            <option value="Clear">Clear</option>
                                            <option value="Rainy">Rainy</option>
                                            <option value="Foggy">Foggy</option>
                                            <option value="Snowy">Snowy</option>
                                            <option value="Stormy">Stormy</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="road_surface" class="form-label">Road Surface</label>
                                        <select class="form-select" id="road_surface" name="road_surface">
                                            <option value="Dry">Dry</option>
                                            <option value="Wet">Wet</option>
                                            <option value="Icy">Icy</option>
                                            <option value="Muddy">Muddy</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="visibility" class="form-label">Visibility</label>
                                        <select class="form-select" id="visibility" name="visibility">
                                            <option value="high">High (>200m)</option>
                                            <option value="medium">Medium (50-200m)</option>
                                            <option value="low">Low (<50m)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="light_condition" class="form-label">Light Condition</label>
                                        <select class="form-select" id="light_condition" name="light_condition">
                                            <option value="Daylight">Daylight</option>
                                            <option value="Night_with_lights">Night (Street lights)</option>
                                            <option value="Night_without_lights">Night (No lights)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Road & Traffic Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h4>
                                        <i class="fas fa-road"></i> Road & Traffic Conditions
                                        <span class="auto-filled-badge" id="roadBadge" style="display:none;">
                                            <i class="fas fa-bolt"></i> Auto-filled
                                        </span>
                                    </h4>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="road_type" class="form-label">Road Type</label>
                                        <select class="form-select" id="road_type" name="road_type">
                                            <option value="City_Road">City Road</option>
                                            <option value="Highway">Highway</option>
                                            <option value="Rural_Road">Rural Road</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="road_design" class="form-label">Road Design</label>
                                        <select class="form-select" id="road_design" name="road_design">
                                            <option value="Straight">Straight</option>
                                            <option value="Curved">Curved</option>
                                            <option value="Junction">Junction/Intersection</option>
                                            <option value="Roundabout">Roundabout</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="traffic_volume" class="form-label">Traffic Volume</label>
                                        <select class="form-select" id="traffic_volume" name="traffic_volume">
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="speed_limit" class="form-label">Speed Limit (km/h)</label>
                                        <input type="number" class="form-control" id="speed_limit" name="speed_limit" min="20" max="120" value="60">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="current_speed" class="form-label">Current Speed (km/h)</label>
                                        <input type="number" class="form-control" id="current_speed" name="current_speed" min="0" max="150" value="50">
                                    </div>
                                </div>
                            </div>

                            <!-- Time & Additional Factors -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h4>
                                        <i class="fas fa-clock"></i> Time & Additional Risk Factors
                                        <span class="auto-filled-badge" id="timeBadge" style="display:none;">
                                            <i class="fas fa-bolt"></i> Auto-filled
                                        </span>
                                    </h4>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="time_of_day" class="form-label">Time of Day</label>
                                        <select class="form-select" id="time_of_day" name="time_of_day">
                                            <option value="Morning">Morning (6-12)</option>
                                            <option value="Afternoon">Afternoon (12-17)</option>
                                            <option value="Evening">Evening (17-21)</option>
                                            <option value="Night">Night (21-6)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="is_weekend" class="form-label">Day Type</label>
                                        <select class="form-select" id="is_weekend" name="is_weekend">
                                            <option value="false">Weekday</option>
                                            <option value="true">Weekend</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="accident_history" class="form-label">Recent Accidents in Area</label>
                                        <input type="number" class="form-control" id="accident_history" name="accident_history" min="0" max="20" value="0">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="overtaking" class="form-label">Overtaking Involved</label>
                                        <select class="form-select" id="overtaking" name="overtaking">
                                            <option value="no">No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="phone_usage" class="form-label">Phone Usage</label>
                                        <select class="form-select" id="phone_usage" name="phone_usage">
                                            <option value="no">No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="alcohol" class="form-label">Alcohol Involvement</label>
                                        <select class="form-select" id="alcohol" name="alcohol">
                                            <option value="no">No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-predict btn-lg">
                                    <i class="fas fa-brain"></i> Analyze Risk with AI
                                </button>
                            </div>
                        </form>

                        <!-- Loading Animation -->
                        <div id="loading" class="text-center mt-4" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p class="mt-3"><i class="fas fa-cogs"></i> AI Model Processing...</p>
                            <small class="text-muted">Analyzing 55+ risk parameters</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <h4 id="processingTitle">Processing...</h4>
            <p id="processingMessage" class="text-muted">Please wait</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/auto_mode.js') }}"></script>
    <script>
        // Global state
        let currentMode = 'manual';
        let licenseData = null;
        let routeData = null;
        let weatherData = null;

        // MODE TOGGLE
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const mode = this.dataset.mode;
                switchMode(mode);
            });
        });

        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Update descriptions
            document.getElementById('manual-desc').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('auto-desc').style.display = mode === 'auto' ? 'block' : 'none';

            // Show/hide auto mode panel
            document.getElementById('autoModePanel').classList.toggle('active', mode === 'auto');

            // Reset form if switching modes
            if (mode === 'manual') {
                enableAllFields();
                hideAutoBadges();
            }
        }

        function hideAutoBadges() {
            document.querySelectorAll('.auto-filled-badge').forEach(badge => badge.style.display = 'none');
        }

        function showAutoBadge(badgeId) {
            document.getElementById(badgeId).style.display = 'inline-block';
        }

        function enableAllFields() {
            document.querySelectorAll('#riskAssessmentForm input, #riskAssessmentForm select').forEach(field => {
                field.disabled = false;
            });
        }

        function disableAutoFilledFields() {
            // Fields that shouldn't be manually edited in auto mode
            const autoFields = ['driver_age', 'experience', 'license_valid', 'weather', 'road_surface', 
                               'visibility', 'light_condition', 'road_type', 'traffic_volume', 'speed_limit'];
            
            autoFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.disabled = true;
            });
        }

        // LICENSE UPLOAD
        const licenseInput = document.getElementById('licenseInput');
        const uploadZone = document.getElementById('licenseUploadZone');

        uploadZone.addEventListener('click', () => licenseInput.click());

        // Drag & Drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleLicenseUpload(files[0]);
            }
        });

        licenseInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleLicenseUpload(this.files[0]);
            }
        });

        async function handleLicenseUpload(file) {
            // Validate file
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('licenseImage').src = e.target.result;
                document.getElementById('licensePreview').style.display = 'block';
                uploadZone.style.display = 'none';
            };
            reader.readAsDataURL(file);

            // Process with OCR
            await processLicenseWithOCR(file);
        }

        async function processLicenseWithOCR(file) {
            const statusDiv = document.getElementById('licenseStatus');
            statusDiv.className = 'license-status processing';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting license information...';

            const formData = new FormData();
            formData.append('license', file);

            try {
                const response = await fetch('/api/process-license', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    licenseData = result.data;
                    
                    // Update status
                    statusDiv.className = 'license-status valid';
                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> License validated successfully!';

                    // Show extracted info
                    displayExtractedInfo(result.data);

                    // Fill form fields
                    fillDriverInfo(result.data);

                    // Move to next step
                    setTimeout(() => moveToStep(2), 1500);

                } else {
                    throw new Error(result.error || 'OCR processing failed');
                }

            } catch (error) {
                console.error('License processing error:', error);
                statusDiv.className = 'license-status invalid';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + error.message;
            }
        }

        function displayExtractedInfo(data) {
            const list = document.getElementById('extractedDataList');
            list.innerHTML = `
                <li><strong>Name:</strong> ${data.name || 'N/A'}</li>
                <li><strong>Age:</strong> ${data.age || 'N/A'}</li>
                <li><strong>License Number:</strong> ${data.license_number || 'N/A'}</li>
                <li><strong>Valid Until:</strong> ${data.expiry_date || 'N/A'}</li>
                <li><strong>Experience:</strong> ${data.experience || 'N/A'} years</li>
                <li><strong>Vehicle Class:</strong> ${data.vehicle_class || 'N/A'}</li>
            `;
            document.getElementById('extractedInfo').style.display = 'block';
        }

        function fillDriverInfo(data) {
            if (data.age) document.getElementById('driver_age').value = data.age;
            if (data.experience) document.getElementById('experience').value = data.experience;
            if (data.is_valid !== undefined) {
                document.getElementById('license_valid').value = data.is_valid ? 'yes' : 'no';
            }
            if (data.vehicle_class) {
                const vehicleType = mapVehicleClass(data.vehicle_class);
                document.getElementById('vehicle_type').value = vehicleType;
            }

            showAutoBadge('driverBadge');
        }

        function mapVehicleClass(vehicleClass) {
            const mapping = {
                'MC': 'Bike',
                'LMV': 'Car',
                'HMV': 'Truck',
                'Transport': 'Bus'
            };
            return mapping[vehicleClass] || 'Car';
        }

        function resetLicenseUpload() {
            document.getElementById('licensePreview').style.display = 'none';
            uploadZone.style.display = 'block';
            licenseInput.value = '';
            licenseData = null;
            moveToStep(1);
        }

        // STEP MANAGEMENT
        function moveToStep(stepNumber) {
            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                const num = index + 1;
                step.classList.remove('active', 'completed');
                if (num < stepNumber) step.classList.add('completed');
                if (num === stepNumber) step.classList.add('active');
            });

            // Show/hide sections
            document.getElementById('licenseUploadSection').style.display = stepNumber === 1 ? 'block' : 'none';
            document.getElementById('routeSelectionSection').style.display = stepNumber === 2 ? 'block' : 'none';
            document.getElementById('reviewSection').style.display = stepNumber === 3 ? 'block' : 'none';
        }

        // ROUTE SELECTION
        async function useCurrentLocationAsSource() {
            showProcessing('Getting Location', 'Detecting your current position...');
            
            if (!navigator.geolocation) {
                hideProcessing();
                alert('Geolocation not supported by your browser');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const data = await response.json();
                        document.getElementById('autoSourceLocation').value = data.display_name;
                        hideProcessing();
                    } catch (error) {
                        hideProcessing();
                        alert('Failed to get location name');
                    }
                },
                function(error) {
                    hideProcessing();
                    alert('Failed to get location: ' + error.message);
                }
            );
        }

        async function analyzeRoute() {
            const source = document.getElementById('autoSourceLocation').value;
            const destination = document.getElementById('autoDestLocation').value;

            if (!source || !destination) {
                alert('Please enter both source and destination');
                return;
            }

            showProcessing('Analyzing Route', 'Getting route details, traffic, and weather data...');

            try {
                const response = await fetch('/api/analyze-route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, destination })
                });

                const result = await response.json();

                if (result.success) {
                    routeData = result.route_data;
                    weatherData = result.weather_data;

                    // Fill location and road info
                    fillRouteInfo(result.route_data);
                    
                    // Fill weather info
                    fillWeatherInfo(result.weather_data);

                    // Fill temporal data
                    fillTemporalData();

                    // Show weather widget
                    displayWeatherWidget(result.weather_data);

                    hideProcessing();
                    moveToStep(3);

                } else {
                    throw new Error(result.error || 'Route analysis failed');
                }

            } catch (error) {
                hideProcessing();
                alert('Error analyzing route: ' + error.message);
            }
        }

        function fillRouteInfo(data) {
            if (data.location) document.getElementById('location').value = data.location;
            if (data.area_type) document.getElementById('area_type').value = data.area_type;
            if (data.road_type) document.getElementById('road_type').value = data.road_type;
            if (data.road_design) document.getElementById('road_design').value = data.road_design;
            if (data.traffic_volume) document.getElementById('traffic_volume').value = data.traffic_volume;
            if (data.speed_limit) document.getElementById('speed_limit').value = data.speed_limit;
            if (data.accident_history) document.getElementById('accident_history').value = data.accident_history;

            showAutoBadge('locationBadge');
            showAutoBadge('roadBadge');
        }

        function fillWeatherInfo(data) {
            if (data.weather) document.getElementById('weather').value = data.weather;
            if (data.road_surface) document.getElementById('road_surface').value = data.road_surface;
            if (data.visibility) document.getElementById('visibility').value = data.visibility;
            if (data.light_condition) document.getElementById('light_condition').value = data.light_condition;

            showAutoBadge('weatherBadge');
        }

        function fillTemporalData() {
            const now = new Date();
            const hour = now.getHours();
            const isWeekend = now.getDay() === 0 || now.getDay() === 6;

            let timeOfDay = 'Morning';
            if (hour >= 12 && hour < 17) timeOfDay = 'Afternoon';
            else if (hour >= 17 && hour < 21) timeOfDay = 'Evening';
            else if (hour >= 21 || hour < 6) timeOfDay = 'Night';

            document.getElementById('time_of_day').value = timeOfDay;
            document.getElementById('is_weekend').value = isWeekend.toString();

            showAutoBadge('timeBadge');
        }

        function displayWeatherWidget(data) {
            document.getElementById('weatherWidget').style.display = 'block';
            document.getElementById('currentWeather').textContent = data.weather || '-';
            document.getElementById('currentTemp').textContent = data.temperature || '-';
            document.getElementById('currentVisibility').textContent = data.visibility_text || '-';
            document.getElementById('roadSurfaceCondition').textContent = data.road_surface || '-';
        }

        // PROCESSING OVERLAY
        function showProcessing(title, message) {
            document.getElementById('processingTitle').textContent = title;
            document.getElementById('processingMessage').textContent = message;
            document.getElementById('processingOverlay').classList.add('active');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.remove('active');
        }

        // MANUAL MODE - Existing functionality
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const hour = now.getHours();
            const isWeekend = now.getDay() === 0 || now.getDay() === 6;
            
            let timeOfDay = 'Morning';
            if (hour >= 12 && hour < 17) timeOfDay = 'Afternoon';
            else if (hour >= 17 && hour < 21) timeOfDay = 'Evening';
            else if (hour >= 21 || hour < 6) timeOfDay = 'Night';
            
            document.getElementById('time_of_day').value = timeOfDay;
            document.getElementById('is_weekend').value = isWeekend.toString();
            
            if (hour >= 6 && hour <= 18) {
                document.getElementById('light_condition').value = 'Daylight';
            } else {
                document.getElementById('light_condition').value = 'Night_with_lights';
            }

            // Manual location button
            const useLocationBtn = document.getElementById('use-location-btn');
            if (useLocationBtn) {
                useLocationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (!navigator.geolocation) {
                        alert('Geolocation is not supported');
                        return;
                    }
                    
                    useLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
                    useLocationBtn.disabled = true;
                    
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                                const data = await response.json();
                                
                                if (data && data.display_name) {
                                    document.getElementById('location').value = data.display_name;
                                    
                                    const address = data.address || {};
                                    const areaTypeSelect = document.getElementById('area_type');
                                    if (address.city || address.town) {
                                        areaTypeSelect.value = 'Urban';
                                    } else if (address.village || address.hamlet) {
                                        areaTypeSelect.value = 'Rural';
                                    } else {
                                        areaTypeSelect.value = 'Suburban';
                                    }
                                }
                                
                            } catch (error) {
                                console.error('Geocoding error:', error);
                            }
                            
                            useLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                            useLocationBtn.disabled = false;
                        },
                        function(error) {
                            alert('Location detection failed: ' + error.message);
                            useLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                            useLocationBtn.disabled = false;
                        }
                    );
                });
            }
        });

        // FORM SUBMISSION
        document.getElementById('riskAssessmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            document.getElementById('loading').style.display = 'block';
            
            const formData = new FormData(this);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Convert numeric fields
            data.driver_age = parseInt(data.driver_age);
            data.experience = parseInt(data.experience);
            data.speed_limit = parseInt(data.speed_limit);
            data.current_speed = parseInt(data.current_speed);
            data.accident_history = parseInt(data.accident_history);
            data.is_weekend = data.is_weekend === 'true';
            
            // Add mode information
            data.mode = currentMode;
            if (currentMode === 'auto') {
                data.license_data = licenseData;
                data.route_data = routeData;
                data.weather_data = weatherData;
            }
            
            console.log('Sending data to backend:', data);
            
            fetch('/api/predict_comprehensive', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(result => {
                document.getElementById('loading').style.display = 'none';
                
                if (result.success) {
                    localStorage.setItem('prediction_result', JSON.stringify(result));
                    window.location.href = '/results';
                } else {
                    throw new Error(result.error || 'Prediction failed');
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                console.error('Prediction error:', error);
                alert('Prediction failed: ' + error.message);
            });
        });
    </script>
</body>
</html>